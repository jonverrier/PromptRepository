#!/bin/sh
# Enforce AGENTS.md: no AI attribution. Strip any trailers, add single Signed-off-by from git config.

msgfile="$1"
[ -f "$msgfile" ] || exit 0

# Body = everything except trailing trailer block (lines at end matching "Key: value" or blank)
body=$(awk '
  { lines[NR]=$0 }
  END {
    last = 0
    for (i = NR; i >= 1; i--) {
      if (lines[i] ~ /^[ \t]*$/) continue
      if (lines[i] ~ /^[A-Za-z][A-Za-z-]*: /) { last = i - 1; continue }
      last = i
      break
    }
    for (i = 1; i <= last; i++) print lines[i]
  }
' "$msgfile")

fullname=$(git config user.name)
forename="${fullname%% *}"
surname="${fullname#* }"
if [ -n "$surname" ]; then
  initial="${surname%${surname#?}}"
  signedname="${forename} ${initial}."
else
  signedname="$forename"
fi
printf '%s\n\nSigned-off-by: %s\n' "$body" "$signedname" > "$msgfile"
exit 0
